WITH visit AS (
    SELECT
        "fullVisitorId" AS fullvisitorid,
        MIN("date") AS date_first_visit
    FROM (
        SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170201
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170202
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170203
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170204
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170205
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170206
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170207
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170208
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170209
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170210
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170211
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170212
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170213
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170214
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170215
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170216
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170217
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170218
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170219
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170220
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170221
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170222
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170223
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170224
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170225
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170226
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170227
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170228
    ) AS combined_sessions
    GROUP BY "fullVisitorId"
),

transactions AS (
    SELECT
        "fullVisitorId" AS fullvisitorid,
        MIN("date") AS date_transactions
    FROM (
        SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170201
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170202
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170203
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170204
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170205
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170206
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170207
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170208
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170209
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170210
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170211
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170212
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170213
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170214
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170215
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170216
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170217
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170218
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170219
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170220
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170221
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170222
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170223
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170224
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170225
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170226
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170227
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170228
    ) AS combined_sessions,
    LATERAL FLATTEN(input => combined_sessions."hits") AS hits
    WHERE
        hits.value:"transaction":transactionId IS NOT NULL
    GROUP BY "fullVisitorId"
),

device_transactions AS (
    SELECT DISTINCT
        "fullVisitorId" AS fullvisitorid,
        "date" AS date,
        PARSE_JSON(combined_sessions."device"):deviceCategory::STRING AS deviceCategory
    FROM (
        SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170201
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170202
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170203
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170204
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170205
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170206
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170207
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170208
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170209
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170210
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170211
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170212
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170213
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170214
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170215
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170216
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170217
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170218
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170219
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170220
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170221
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170222
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170223
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170224
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170225
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170226
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170227
        UNION ALL SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170228
    ) AS combined_sessions,
    LATERAL FLATTEN(input => combined_sessions."hits") AS hits
    WHERE
        hits.value:"transaction":transactionId IS NOT NULL
),

visits_transactions AS (
    SELECT
        visit.fullvisitorid,
        date_first_visit,
        date_transactions,
        device_transactions.deviceCategory AS device_transaction
    FROM
        visit
        JOIN transactions ON visit.fullvisitorid = transactions.fullvisitorid
        JOIN device_transactions ON visit.fullvisitorid = device_transactions.fullvisitorid 
        AND transactions.date_transactions = device_transactions.date
)

SELECT
       fullvisitorid,
       ABS(DATEDIFF(day, TO_DATE(date_transactions, 'YYYYMMDD'), TO_DATE(date_first_visit, 'YYYYMMDD'))) AS time,
       device_transaction
FROM visits_transactions
ORDER BY fullvisitorid;