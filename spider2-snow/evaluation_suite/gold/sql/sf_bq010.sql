WITH ga_sessions_all AS (
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170701
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170702
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170703
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170704
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170705
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170706
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170707
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170708
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170709
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170710
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170711
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170712
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170713
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170714
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170715
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170716
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170717
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170718
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170719
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170720
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170721
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170722
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170723
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170724
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170725
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170726
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170727
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170728
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170729
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170730
    UNION ALL
    SELECT * FROM GA360.GOOGLE_ANALYTICS_SAMPLE.ga_sessions_20170731
),
GET_CUS_ID AS (
    SELECT DISTINCT
        "fullVisitorId" AS Henley_CUSTOMER_ID
    FROM (
        SELECT "fullVisitorId"
        FROM ga_sessions_all,
        LATERAL FLATTEN(input => "hits") AS hits,
        LATERAL FLATTEN(input => hits.value:"product") AS product
        WHERE product.value:"v2ProductName" = 'YouTube Men''s Vintage Henley'
          AND product.value:"productRevenue" IS NOT NULL
    ) AS combined
    WHERE "fullVisitorId" IS NOT NULL
),
OTHER_PURCHASED_PRODUCTS AS (
    SELECT 
        "fullVisitorId" AS Henley_CUSTOMER_ID,
        product.value:"v2ProductName" AS other_purchased_products, 
        product.value:"productQuantity" quantity
    FROM ga_sessions_all,
    LATERAL FLATTEN(input => "hits") AS hits,
    LATERAL FLATTEN(input => hits.value:"product") AS product
    WHERE product.value:"v2ProductName" != 'YouTube Men''s Vintage Henley' 
      AND product.value:"productRevenue" IS NOT NULL
)
SELECT
    REPLACE(OTHER_PURCHASED_PRODUCTS.other_purchased_products, '"', '') AS product_name
FROM GET_CUS_ID
JOIN OTHER_PURCHASED_PRODUCTS
    ON GET_CUS_ID.Henley_CUSTOMER_ID = OTHER_PURCHASED_PRODUCTS.Henley_CUSTOMER_ID
WHERE quantity IS NOT NULL
GROUP BY product_name
ORDER BY SUM(OTHER_PURCHASED_PRODUCTS.quantity) DESC
LIMIT 1;
